<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>üç¥ THE FORK // STACK v01</title>

  <!-- FAVICON -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23ff9d5c' d='M50 0 L93.3 25 V75 L50 100 L6.7 75 V25 Z'/%3E%3Cpath fill='none' stroke='%23050505' stroke-width='6' d='M38 28v44M50 28v44M62 28v44M38 50h24'/%3E%3C/svg%3E"/>

  <style>
    :root {
      /* --- THEME: EXCAVATION (High Contrast Dark) --- */
      --bg-void: #050505;
      --bg-panel: #14100f;
      --bg-hover: #261f1d;

      --text-primary: #ffcdb2;
      --text-secondary: #b0988e;
      --text-muted: #6b554e;

      --border: #4a3832;
      --accent: #ff9d5c;
      --accent-glow: rgba(255, 157, 92, 0.18);

      /* CATEGORY COLORS */
      --class-core: #ffaa75;
      --class-media: #75b3ff;
      --class-tool: #75ffaa;
      --class-exp: #e075ff;

      --header-height: 52px;
      --row-height: 60px;
      --sidebar-width: 24px;

      --ease-mech: cubic-bezier(0.25, 0.46, 0.45, 0.94);
      --ease-snap: cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    html[data-theme="light"] {
      --bg-void: #ffffff;
      --bg-panel: #f0f0f0;
      --bg-hover: #e6e6e6;

      --text-primary: #000000;
      --text-secondary: #4a4a4a;
      --text-muted: #888888;

      --border: #cccccc;
      --accent: #d13d00;
      --accent-glow: rgba(209, 61, 0, 0.10);

      --class-core: #d13d00;
      --class-media: #0044cc;
      --class-tool: #007733;
      --class-exp: #770099;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body, html {
      margin: 0; padding: 0;
      background: var(--bg-void);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      height: 100%; width: 100%;
      overflow: hidden;
      color: var(--text-primary);
      transition: background-color 0.25s, color 0.25s;
    }

    #sequencer-ui { display: flex; flex-direction: column; height: 100%; width: 100%; }

    /* HEADER */
    #global-hud {
      height: var(--header-height);
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 10px;
      z-index: 100;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      gap: 10px;
    }

    .hud-left { display: flex; align-items: center; gap: 10px; min-width: 180px; }
    .hud-title {
      display: flex; flex-direction: column; line-height: 1.05;
      user-select: none;
    }
    .hud-title .top { font-weight: 900; letter-spacing: 1px; font-size: 0.82rem; }
    .hud-title .sub { font-size: 0.62rem; color: var(--text-secondary); letter-spacing: 0.5px; }

    .hud-logo {
      width: 24px; height: 24px;
      color: var(--accent);
      cursor: pointer;
      transition: transform 0.3s var(--ease-snap);
      flex: 0 0 auto;
    }
    .hud-logo:hover { transform: rotate(90deg); filter: drop-shadow(0 0 4px var(--accent)); }

    .hud-center {
      flex: 1 1 auto;
      display: flex; align-items: center; justify-content: center;
      min-width: 120px;
    }
    .filter-wrap {
      width: min(520px, 100%);
      display: flex; align-items: center; gap: 8px;
      padding: 6px 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.00));
    }
    .filter-dot {
      width: 6px; height: 6px; border-radius: 99px;
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent-glow);
      flex: 0 0 auto;
    }
    #filter {
      width: 100%;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-primary);
      font-size: 0.78rem;
    }
    #filter::placeholder { color: var(--text-muted); }

    .hud-controls { display: flex; gap: 6px; flex: 0 0 auto; }

    .btn-icon {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      width: 34px; height: 34px;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 0.9rem;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s;
      user-select: none;
      touch-action: manipulation;
    }
    .btn-icon:hover {
      border-color: var(--text-primary);
      color: var(--text-primary);
      background: var(--bg-hover);
    }
    .btn-icon.active { background: var(--text-secondary); color: var(--bg-void); }

    /* WORKSPACE */
    #workspace { display: flex; flex-grow: 1; overflow: hidden; position: relative; }

    /* LEFT RAIL (PROGRESS) */
    .dna-rail {
      width: var(--sidebar-width);
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column; align-items: center;
      padding-top: 10px;
      z-index: 10;
      position: relative;
      flex: 0 0 auto;
    }
    .rail-track { position: absolute; top: 0; bottom: 0; width: 2px; background: var(--border); z-index: 0; }
    .rail-progress {
      position: absolute; top: 0; left: 50%; transform: translateX(-50%);
      width: 4px; background: var(--accent);
      height: 0%;
      z-index: 1;
      transition: height 0.08s linear;
    }
    .rail-mark {
      width: 10px; height: 1px; background: var(--text-muted);
      margin: 0;
      position: absolute;
      left: 50%; transform: translateX(-50%);
      opacity: 0.7;
    }

    /* SCROLL AREA */
    #genome-scroll {
      flex-grow: 1;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
      position: relative;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
    }
    #genome-scroll::-webkit-scrollbar { display: none; }

    /* GENE LIST */
    #gene-list { display: flex; flex-direction: column; width: 100%; }

    /* GRID MODE */
    #gene-list.grid-mode {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      padding: 12px;
      align-items: start;
    }

    /* GENE ROW */
    .gene-row {
      background: var(--bg-void);
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      transition: background 0.25s, transform 0.25s, border-color 0.25s;
      overflow: hidden;
    }
    #gene-list.grid-mode .gene-row {
      border: 1px solid var(--border);
      height: 140px;
      border-radius: 8px;
      position: relative;
    }
    #gene-list.grid-mode .gene-row.active {
      grid-column: 1 / -1;
      height: auto;
      border-color: var(--accent);
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }

    /* HEADER ROW */
    .gene-header {
      height: var(--row-height);
      display: flex;
      align-items: center;
      padding: 0 10px;
      cursor: pointer;
      user-select: none;
      background: var(--bg-void);
      position: relative;
      flex-shrink: 0;
      overflow: hidden;
      z-index: 2;
      touch-action: manipulation;
    }
    .gene-header:hover { background: var(--bg-hover); }

    #gene-list.grid-mode .gene-row:not(.active) .gene-header {
      height: 100%;
      flex-direction: column;
      align-items: flex-start;
      justify-content: space-between;
      padding: 10px;
    }
    #gene-list.grid-mode .gene-row:not(.active) .id-cluster {
      width: 100%;
      border-right: none;
      height: auto;
      margin-bottom: 8px;
    }
    #gene-list.grid-mode .gene-row:not(.active) .gene-controls { display: none; }
    #gene-list.grid-mode .gene-row:not(.active) .gene-info { width: 100%; }
    #gene-list.grid-mode .gene-row:not(.active) .gene-barcode { height: 6px; }

    .id-cluster {
      display: flex; align-items: center; height: 100%;
      width: 56px; flex-shrink: 0;
      border-right: 1px solid var(--border);
      margin-right: 10px;
    }
    .class-indicator { width: 3px; height: 100%; margin-right: 6px; background: var(--text-muted); }
    .gene-barcode { flex-grow: 1; height: 20px; opacity: 0.75; }

    .gene-info {
      display: flex; flex-direction: column; justify-content: center;
      align-items: flex-start;
      flex-grow: 1; overflow: hidden;
      min-width: 0;
    }
    .gene-title {
      font-size: 0.85rem;
      font-weight: 900;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      color: var(--text-primary);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      width: 100%;
    }
    .gene-desc {
      font-size: 0.66rem;
      color: var(--text-secondary);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      width: 100%;
      margin-top: 4px;
    }

    .gene-controls {
      margin-left: 10px;
      display: flex; align-items: center; gap: 6px;
      flex: 0 0 auto;
    }
    .ext-link {
      text-decoration: none;
      color: var(--text-secondary);
      padding: 7px;
      border-radius: 6px;
      transition: all 0.15s;
      touch-action: manipulation;
    }
    .ext-link:hover { color: var(--text-primary); background: var(--bg-hover); }
    .arrow-indicator {
      font-size: 0.75rem;
      color: var(--text-secondary);
      transition: transform 0.35s var(--ease-snap);
    }

    /* ACTIVE */
    .gene-row.active { background: var(--bg-hover); border-bottom-color: var(--accent); }
    .gene-row.active .class-indicator { box-shadow: 0 0 10px currentColor; }
    .gene-row.active .gene-barcode { opacity: 1; filter: contrast(1.2); }
    .gene-row.active .arrow-indicator { transform: rotate(90deg); color: var(--accent); }

    /* EXPRESSION WINDOW */
    .expression-window {
      height: 0;
      overflow: hidden;
      transition: height 0.55s var(--ease-mech);
      background: #000;
      position: relative;
      transform-origin: top;
      will-change: height;
    }
    .gene-row.active .expression-window { height: 70vh; }

    .signal-loader {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      color: var(--text-muted);
      font-size: 0.72rem;
      letter-spacing: 2px;
      animation: pulse 1.5s infinite;
      pointer-events: none;
      z-index: 0;
    }
    @keyframes pulse { 0% { opacity: 0.25; } 50% { opacity: 1; } 100% { opacity: 0.25; } }

    iframe {
      width: 100%; height: 100%;
      border: none;
      position: relative;
      z-index: 1;
      opacity: 0;
      transition: opacity 0.4s ease-in 0.15s;
      background: #000;
    }
    .gene-row.active iframe.loaded { opacity: 1; }

    /* RIGHT RAIL (MINIMAP) */
    #minimap-rail {
      width: 16px;
      background: var(--bg-panel);
      border-left: 1px solid var(--border);
      position: relative;
      cursor: pointer;
      touch-action: none;
      flex: 0 0 auto;
    }

    .map-indicator {
      width: 100%;
      position: absolute;
      left: 0;
      opacity: 0.35;
      height: 2px;
      transition: opacity 0.15s, height 0.15s, box-shadow 0.15s;
      pointer-events: none;
    }
    .map-indicator.active {
      opacity: 1;
      height: 4px;
      box-shadow: -2px 0 10px currentColor;
      z-index: 2;
    }

    #minimap-lens {
      position: absolute;
      left: 0; right: 0;
      height: 12%;
      top: 0;
      border: 2px solid var(--accent);
      background: var(--accent-glow);
      z-index: 10;
      border-radius: 2px;
      cursor: grab;
      transition: top 0.08s linear, height 0.08s linear, background-color 0.2s;
    }
    #minimap-lens:active { cursor: grabbing; background: var(--accent); opacity: 0.5; }

    /* MODAL */
    #about-modal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.82);
      backdrop-filter: blur(6px);
      z-index: 999;
      display: flex; align-items: center; justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s;
    }
    #about-modal.visible { opacity: 1; pointer-events: all; }

    .modal-box {
      background: var(--bg-void);
      border: 1px solid var(--text-primary);
      padding: 20px;
      max-width: 520px;
      width: min(92vw, 520px);
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
      border-radius: 10px;
    }
    .modal-header {
      border-bottom: 1px solid var(--border);
      padding-bottom: 10px;
      margin-bottom: 14px;
      font-weight: 900;
      color: var(--text-primary);
      letter-spacing: 2px;
      font-size: 0.95rem;
    }
    .modal-body {
      font-size: 0.84rem;
      color: var(--text-secondary);
      line-height: 1.55;
    }
    .modal-body .kicker {
      color: var(--text-primary);
      font-weight: 900;
      letter-spacing: 0.8px;
    }
    .modal-links {
      margin-top: 12px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      font-size: 0.78rem;
    }
    .modal-links a {
      color: var(--text-primary);
      text-decoration: none;
      border: 1px solid var(--border);
      padding: 8px 10px;
      border-radius: 8px;
      background: var(--bg-panel);
    }
    .modal-links a:hover { background: var(--bg-hover); border-color: var(--accent); }
    .btn-text {
      margin-top: 14px;
      width: 100%;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 11px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 900;
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-radius: 10px;
    }
    .btn-text:hover { background: var(--bg-hover); border-color: var(--accent); }
  </style>
</head>

<body>
  <!-- ABOUT MODAL -->
  <div id="about-modal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true" aria-label="About The Fork">
      <div class="modal-header">üç¥ THE FORK // MANIFEST v01</div>

      <div class="modal-body">
        <div class="kicker">The Fork</div>
        A laboratory for ethical negotiation through conversation with moral agents.<br><br>

        <span class="kicker">Mission</span><br>
        Transform ethical reasoning from solitary puzzle-solving into dynamic dialogue: negotiate inside concrete scenarios with agents embodying distinct moral frameworks. Learn the *journey* of moral reasoning, not just the verdict.<br><br>

        <span class="kicker">Stack</span><br>
        Eight cartridges, iframe-load-on-demand, grid/list traversal, minimap lens, expand-all.
      </div>

      <div class="modal-links">
        <a href="https://hartswf0.github.io/the-fork/" target="_blank" rel="noopener">Live Deployment ‚ñ∏ hartswf0.github.io/the-fork/</a>
        <a href="https://github.com/hartswf0/the-fork" target="_blank" rel="noopener">GitHub Repo ‚ñ∏ github.com/hartswf0/the-fork</a>
      </div>

      <button class="btn-text" onclick="toggleAbout()">INITIALIZE</button>
    </div>
  </div>

  <div id="sequencer-ui">
    <!-- HEADER -->
    <header id="global-hud">
      <div class="hud-left">
        <svg class="hud-logo" onclick="toggleAbout()" viewBox="0 0 100 100" aria-label="Open Manifest" role="button">
          <path d="M50 10 L90 30 V70 L50 90 L10 70 V30 Z" fill="none" stroke="currentColor" stroke-width="4"/>
          <circle cx="50" cy="50" r="10" fill="currentColor"/>
          <path d="M50 10 V38 M50 90 V62 M10 30 L38 44 M90 30 L62 44 M10 70 L38 56 M90 70 L62 56" stroke="currentColor" stroke-width="2"/>
        </svg>

        <div class="hud-title">
          <div class="top">THE FORK // STACK</div>
          <div class="sub">ethical negotiation cartridges (x1‚Äìx8)</div>
        </div>
      </div>

      <div class="hud-center">
        <div class="filter-wrap" title="Filter cartridges">
          <div class="filter-dot"></div>
          <input id="filter" placeholder="filter (e.g. railway, tetrad, role, memory‚Ä¶)" autocomplete="off" />
        </div>
      </div>

      <div class="hud-controls">
        <!-- Grid/List Toggle -->
        <button class="btn-icon" onclick="toggleGrid()" id="view-toggle" title="Toggle Grid/List View" aria-label="Toggle view">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
            <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
          </svg>
        </button>

        <button class="btn-icon" onclick="toggleTheme()" title="Toggle Theme" aria-label="Toggle theme">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
          </svg>
        </button>

        <button class="btn-icon" onclick="toggleAll()" id="expand-btn" title="Expand All" aria-label="Expand all">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <path d="M8 12h8"/>
            <path d="M12 8v8" id="expand-icon-path"/>
          </svg>
        </button>
      </div>
    </header>

    <div id="workspace">
      <!-- LEFT RAIL -->
      <div class="dna-rail" aria-hidden="true">
        <div class="rail-track"></div>
        <div class="rail-progress" id="rail-progress"></div>
      </div>

      <!-- MAIN SCROLL -->
      <main id="genome-scroll">
        <div id="gene-list"></div>
        <div style="height: 90px;"></div>
      </main>

      <!-- RIGHT RAIL -->
      <div id="minimap-rail" aria-label="Minimap rail">
        <div id="minimap-lens" aria-hidden="true"></div>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIG ---
    const BASE_URL = "https://hartswf0.github.io/the-fork/";

    // --- FORK-x1..x8 (as requested) ---
    const DATA = [
      { file: "fork-x1.html", desc: "Primary ethical negotiation interface", class: "core" },
      { file: "fork-x2.html", desc: "Game-theory forking grid", class: "tool" },
      { file: "fork-x3.html", desc: "Thousand Tetrad: multi-framework analysis", class: "media" },
      { file: "fork-x4.html", desc: "Railway cartridge: full integration", class: "core" },
      { file: "fork-x5.html", desc: "Train-Brain19 instance / experiment", class: "exp" },
      { file: "fork-x6.html", desc: "Functional substrate index", class: "tool" },
      { file: "fork-x7.html", desc: "Role Deck hub: workplace/design negotiation", class: "media" },
      { file: "fork-x8.html", desc: "Synarchiv: memory remediation protocol", class: "exp" }
    ];

    const listContainer = document.getElementById('gene-list');
    const mapRail = document.getElementById('minimap-rail');
    const leftRail = document.querySelector('.dna-rail');
    const scrollContainer = document.getElementById('genome-scroll');
    const lens = document.getElementById('minimap-lens');
    const progressBar = document.getElementById('rail-progress');
    const filterInput = document.getElementById('filter');

    let allExpanded = false;
    let isDragging = false;
    let gridMode = false;

    // --- HELPER: Generate Barcode ---
    function generateBarcode(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
      let gradient = "linear-gradient(90deg, ";
      for (let i = 0; i <= 100; i += 10) {
        const val = Math.abs((hash * (i + 1)) % 100);
        gradient += (val > 50)
          ? `currentColor ${i}%, transparent ${i}%, transparent ${i + 5}%, currentColor ${i + 5}%, `
          : `transparent ${i}%, transparent ${i + 10}%, `;
      }
      return gradient.slice(0, -2) + ")";
    }

    function classColorVar(cls) {
      return `var(--class-${cls})`;
    }

    function init() {
      // left rail marks
      for (let i = 0; i < DATA.length; i++) {
        const mark = document.createElement('div');
        mark.className = 'rail-mark';
        mark.style.top = `${(i / DATA.length) * 100}%`;
        leftRail.appendChild(mark);
      }

      DATA.forEach((item, index) => createGene(item, index));
      setTimeout(updateLens, 80);
      setTimeout(updateLens, 280);

      // filter
      filterInput.addEventListener('input', applyFilter);

      // close modal on backdrop click
      document.getElementById('about-modal').addEventListener('click', (e) => {
        if (e.target.id === 'about-modal') toggleAbout();
      });

      // escape closes modal
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const modal = document.getElementById('about-modal');
          if (modal.classList.contains('visible')) toggleAbout();
        }
      });
    }

    function createGene(item, index) {
      const title = item.file.replace('.html', '').toUpperCase();
      const url = BASE_URL + item.file;
      const barcodeStyle = generateBarcode(item.file);
      const colorVar = classColorVar(item.class);

      const row = document.createElement('div');
      row.className = 'gene-row';
      row.id = `gene-${index}`;
      row.dataset.title = title.toLowerCase();
      row.dataset.desc = item.desc.toLowerCase();
      row.dataset.file = item.file.toLowerCase();

      row.innerHTML = `
        <div class="gene-header" onclick="toggleGene(${index})" role="button" aria-label="Toggle ${title}">
          <div class="id-cluster">
            <div class="class-indicator" style="background:${colorVar}; box-shadow:0 0 6px ${colorVar};"></div>
            <div class="gene-barcode" style="background-image:${barcodeStyle}; color:${colorVar}"></div>
          </div>

          <div class="gene-info">
            <span class="gene-title">${title}</span>
            <span class="gene-desc">${item.desc}</span>
          </div>

          <div class="gene-controls">
            <a href="${url}" target="_blank" rel="noopener" class="ext-link" onclick="stopProp(event)" title="Open in New Tab" aria-label="Open in new tab">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                <polyline points="15 3 21 3 21 9"/>
                <line x1="10" y1="14" x2="21" y2="3"/>
              </svg>
            </a>
            <div class="arrow-indicator">‚ñ∂</div>
          </div>
        </div>

        <div class="expression-window">
          <div class="signal-loader">ACQUIRING SIGNAL...</div>
          <iframe id="iframe-${index}" data-src="${url}" title="${title}"></iframe>
        </div>
      `;
      listContainer.appendChild(row);

      const dot = document.createElement('div');
      dot.className = 'map-indicator';
      dot.style.top = `${(index / DATA.length) * 100}%`;
      dot.style.height = `${100 / DATA.length}%`;
      dot.style.setProperty('background', colorVar);
      dot.style.setProperty('color', colorVar);
      dot.id = `map-${index}`;
      mapRail.appendChild(dot);
    }

    // --- FILTER ---
    function applyFilter() {
      const q = (filterInput.value || '').trim().toLowerCase();
      const rows = document.querySelectorAll('.gene-row');

      rows.forEach((row) => {
        const hay = `${row.dataset.file} ${row.dataset.title} ${row.dataset.desc}`;
        const show = q === '' || hay.includes(q);
        row.style.display = show ? '' : 'none';
      });

      setTimeout(updateLens, 80);
      setTimeout(updateLens, 260);
    }

    // --- GENE TOGGLE ---
    window.toggleGene = (index) => {
      const row = document.getElementById(`gene-${index}`);
      if (!row || row.style.display === 'none') return;

      const isActive = row.classList.contains('active');
      isActive ? closeGene(index) : openGene(index);

      checkAllState();
      setTimeout(updateLens, 120);
      setTimeout(updateLens, 420);
    };

    function openGene(index) {
      const row = document.getElementById(`gene-${index}`);
      const iframe = document.getElementById(`iframe-${index}`);
      const mapDot = document.getElementById(`map-${index}`);

      row.classList.add('active');
      mapDot.classList.add('active');

      if (gridMode) {
        setTimeout(() => row.scrollIntoView({ behavior: 'smooth', block: 'center' }), 260);
      }

      if (!iframe.getAttribute('src')) {
        iframe.src = iframe.dataset.src;
        iframe.onload = () => iframe.classList.add('loaded');
      }
    }

    function closeGene(index) {
      const row = document.getElementById(`gene-${index}`);
      const iframe = document.getElementById(`iframe-${index}`);
      const mapDot = document.getElementById(`map-${index}`);

      row.classList.remove('active');
      mapDot.classList.remove('active');

      setTimeout(() => {
        if (!row.classList.contains('active')) {
          iframe.removeAttribute('src');
          iframe.classList.remove('loaded');
        }
      }, 520);
    }

    // --- EXPAND ALL (respects filter visibility) ---
    window.toggleAll = () => {
      allExpanded = !allExpanded;

      const iconPath = document.getElementById('expand-icon-path');
      iconPath.setAttribute('d', allExpanded ? "M6 12h12" : "M12 8v8");

      const btn = document.getElementById('expand-btn');
      btn.classList.toggle('active', allExpanded);

      const visibleIndexes = DATA
        .map((_, i) => i)
        .filter((i) => {
          const row = document.getElementById(`gene-${i}`);
          return row && row.style.display !== 'none';
        });

      visibleIndexes.forEach((index, k) => {
        if (allExpanded) {
          setTimeout(() => openGene(index), k * 40);
        } else {
          setTimeout(() => closeGene(index), k * 15);
        }
      });

      setTimeout(updateLens, (visibleIndexes.length * 40) + 600);
    };

    function checkAllState() {
      const activeCount = document.querySelectorAll('.gene-row.active').length;
      if (activeCount === 0) {
        allExpanded = false;
        document.getElementById('expand-btn').classList.remove('active');
        document.getElementById('expand-icon-path').setAttribute('d', "M12 8v8");
      }
    }

    // --- GRID/LIST ---
    window.toggleGrid = () => {
      gridMode = !gridMode;
      listContainer.classList.toggle('grid-mode', gridMode);
      document.getElementById('view-toggle').classList.toggle('active', gridMode);
      setTimeout(updateLens, 120);
      setTimeout(updateLens, 360);
    };

    // --- THEME ---
    window.toggleTheme = () => {
      const root = document.documentElement;
      const current = root.getAttribute('data-theme') || 'dark';
      root.setAttribute('data-theme', current === 'light' ? 'dark' : 'light');
    };

    // --- ABOUT ---
    window.toggleAbout = () => {
      const modal = document.getElementById('about-modal');
      modal.classList.toggle('visible');
      modal.setAttribute('aria-hidden', modal.classList.contains('visible') ? 'false' : 'true');
    };

    window.stopProp = (e) => e.stopPropagation();

    // --- LENS & SCROLL (fixed math) ---
    function updateLens() {
      const scrollTop = scrollContainer.scrollTop;
      const scrollHeight = scrollContainer.scrollHeight;
      const clientHeight = scrollContainer.clientHeight;

      const denom = Math.max(1, (scrollHeight - clientHeight));
      const lensHeightPerc = Math.min(100, Math.max(8, (clientHeight / scrollHeight) * 100));
      const lensTopPerc = (scrollTop / denom) * (100 - lensHeightPerc);

      lens.style.height = `${lensHeightPerc}%`;
      lens.style.top = `${lensTopPerc}%`;

      const progressPerc = (scrollTop / denom) * 100;
      progressBar.style.height = `${Math.min(100, Math.max(0, progressPerc))}%`;
    }

    scrollContainer.addEventListener('scroll', () => {
      if (!isDragging) requestAnimationFrame(updateLens);
    }, { passive: true });

    // --- RAIL INTERACTION ---
    mapRail.addEventListener('pointerdown', (e) => {
      isDragging = true;
      mapRail.setPointerCapture(e.pointerId);
      handleRailInput(e, 'smooth');
    });

    mapRail.addEventListener('pointermove', (e) => {
      if (!isDragging) return;
      handleRailInput(e, 'auto');
    });

    mapRail.addEventListener('pointerup', (e) => {
      isDragging = false;
      try { mapRail.releasePointerCapture(e.pointerId); } catch {}
    });

    function handleRailInput(e, behavior) {
      const rect = mapRail.getBoundingClientRect();
      const y = e.clientY - rect.top;
      const perc = Math.max(0, Math.min(1, y / rect.height));
      const targetScroll = perc * (scrollContainer.scrollHeight - scrollContainer.clientHeight);
      scrollContainer.scrollTo({ top: targetScroll, behavior });
    }

    init();
  </script>
</body>
</html>
